<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate Orders</title>
    <link rel="stylesheet" href="../css/bootstrap.css">
</head>

<body class="sub_page sidebar-layout">
    <!-- Page Loader -->
    <div id="page-loader"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease;">
        <i class="fa fa-spinner fa-spin" style="font-size: 3rem; color: #00bbf0;"></i>
    </div>
    <div class="container">
        <h1>Order Migration Tool</h1>
        <p>This tool will copy all orders from <code>users/{uid}/orders</code> to the central <code>orders</code>
            collection so they appear in the dashboard.</p>

        <div class="card p-4">
            <h5 id="status">Waiting to start...</h5>
            <div class="progress mb-3" style="height: 25px; display:none;" id="progressContainer">
                <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
            </div>
            <div id="logs"
                style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;">
            </div>
            <button id="startBtn" class="btn btn-primary mt-3">Start Migration</button>
        </div>
    </div>

    <script type="module">
        import { initAdminAuth, db } from '../js/admin-auth.js';
        import { collection, getDocs, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const startBtn = document.getElementById('startBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');

        function log(msg) {
            logsEl.innerHTML += `<div>${msg}</div>`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        initAdminAuth(() => {
            log("Admin Authenticated. Ready.");

            startBtn.addEventListener('click', async () => {
                startBtn.disabled = true;
                progressContainer.style.display = 'block';
                statusEl.innerText = "Fetching Users...";

                try {
                    // 1. Get All Users
                    const usersRef = collection(db, 'users');
                    const usersSnap = await getDocs(usersRef);
                    const users = usersSnap.docs;

                    log(`Found ${users.length} users. Scanning for orders...`);

                    let totalOrdersFound = 0;
                    let totalOrdersMigrated = 0;

                    for (let i = 0; i < users.length; i++) {
                        const userDoc = users[i];
                        const uid = userDoc.id;
                        const userData = userDoc.data();
                        const userName = userData.name || userData.displayName || 'Unknown';
                        const userEmail = userData.email || 'Unknown';

                        const percent = Math.round(((i + 1) / users.length) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressBar.innerText = `${percent}% (User ${i + 1}/${users.length})`;

                        // 2. Get User Orders
                        const userOrdersRef = collection(db, 'users', uid, 'orders');
                        const ordersSnap = await getDocs(userOrdersRef);

                        if (!ordersSnap.empty) {
                            log(`User ${uid}: Found ${ordersSnap.size} orders.`);

                            for (const orderDoc of ordersSnap.docs) {
                                totalOrdersFound++;
                                const orderData = orderDoc.data();
                                const orderId = orderDoc.id;

                                // 3. Copy to Root
                                const rootOrderRef = doc(db, 'orders', orderId);

                                // Check if exists (optional, but safer to just overwrite/merge)
                                const rootSnap = await getDoc(rootOrderRef);
                                if (!rootSnap.exists()) {
                                    await setDoc(rootOrderRef, {
                                        ...orderData,
                                        userId: uid,
                                        userEmail: userEmail, // Ensure email/name is present for display
                                        userName: userName,   // Ensure email/name is present for display
                                        originalOrderPath: `users/${uid}/orders/${orderId}`
                                    });
                                    log(` -> Migrated Order ${orderId}`);
                                    totalOrdersMigrated++;
                                } else {
                                    log(` -> Order ${orderId} already exists. Skipping.`);
                                }
                            }
                        }
                    }

                    statusEl.innerText = "Migration Complete!";
                    statusEl.classList.add('text-success');
                    log(`<strong>DONE! Found ${totalOrdersFound} orders. Migrated ${totalOrdersMigrated} new orders.</strong>`);

                } catch (e) {
                    console.error(e);
                    statusEl.innerText = "Error: " + e.message;
                    statusEl.classList.add('text-danger');
                } finally {
                    startBtn.disabled = false;
                }
            });
        });
    </script>
</body>

</html>